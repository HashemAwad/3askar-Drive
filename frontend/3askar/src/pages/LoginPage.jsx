import React, {useState} from "react";
import { Box, Paper, Typography, TextField, Link, Button, FormControl, InputLabel, Select, MenuItem, Alert, FormHelperText, CircularProgress } from "@mui/material";
const API_URL = import.meta.env.VITE_API_URL;
import { useNavigate } from "react-router-dom";


const isValueEmpty = (value) => {
  if (typeof value === "string") {
    return value.trim() === "";
  }
  return !value;
};

const isValidEmail = (value) => {
  if (typeof value !== "string") {
    return false;
  }
  const trimmed = value.trim();
  if (trimmed === "") {
    return false;
  }
  return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(trimmed);
};

const strongPasswordRegex = /^(?=.*?[A-Z])(?=.*?[a-z])(?=.*?[0-9])(?=.*?[#?!@$%^&*-]).{8,}$/; //taken from https://uibakery.io/regex-library/password

const isStrongPassword = (value) => {
  if (typeof value !== "string") {
    return false;
  }
  return strongPasswordRegex.test(value);
};

export default function LoginPage() {
  const [email, setEmail] = useState("");
  const [password, setPassword] = useState("");
  const [createAlert, setCreateAlert] = useState(null);
  const [showCreateErrors, setShowCreateErrors] = useState(false);
  const [loginAlert, setLoginAlert] = useState(null);
  const [showLoginErrors, setShowLoginErrors] = useState(false);
  const [isGoogleLoading, setIsGoogleLoading] = useState(false);
  const navigate = useNavigate();


  //login button handles logging in the user
  const handleLogin = async ()=> {
    setShowLoginErrors(true);
    const loginRequired = [
      { value: email, label: "Email" },
      { value: password, label: "Password" },
    ];

    const missingFieldsList = loginRequired
      .filter(({ value }) => isValueEmpty(value))
      .map(({ label }) => label);

    if (missingFieldsList.length) {
      setLoginAlert({
        severity: "warning",
        message: "Please fill in the required fields before signing in.",
        details: missingFieldsList,
      });
      return;
    }

    if (!isValidEmail(email)) {
      setLoginAlert({
        severity: "error",
        message: "Please enter a valid email address.",
      });
      return;
    }

    setShowLoginErrors(false);
    setLoginAlert(null);

    const res = await fetch(`${API_URL}/auth/login`, {
      method: "POST",
      headers: {"Content-Type": "application/json"}, // read in json basically
      credentials: "include", //this is to prvoide cookies fo the session
      body: JSON.stringify({
        email: email,
        password: password
      })
    })

    if (!res.ok){
      const errorMessage = await res.text();
      console.log(errorMessage);
    } else{
      const message = await res.text();
      console.log(message);
    }
  };

  //creat account button handles signing up the new user
  const handleCreateAccount = async ()=> {
    setShowCreateErrors(true);
    const requiredFields = [
      { value: firstName, label: "First name" },
      { value: lastName, label: "Last name" },
      { value: dobMonth, label: "Birth month" },
      { value: dobDay, label: "Birth day" },
      { value: dobYear, label: "Birth year" },
      { value: email, label: "Email" },
      { value: password, label: "Password" },
    ];

    const missingFieldsList = requiredFields
      .filter(({ value }) => isValueEmpty(value))
      .map(({ label }) => label);

    if (missingFieldsList.length) {
      setCreateAlert({
        severity: "warning",
        message: "Please fill in the required fields before creating an account.",
        details: missingFieldsList,
      });
      return;
    }

    if (!isStrongPassword(password)) {
      setCreateAlert({
        severity: "error",
        message: "Password must include upper/lower case letters, a number, a symbol, and be at least 8 characters.",
      });
      return;
    }

    if (!isValidEmail(email)) {
      setCreateAlert({
        severity: "error",
        message: "Please enter a valid email address.",
      });
      return;
    }

    setShowCreateErrors(false);
    setCreateAlert(null);

    const res = await fetch(`${API_URL}/auth/register`, {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      credentials: "include",
      body: JSON.stringify({
        firstName, 
        lastName,
        dobMonth,
        dobDay,
        dobYear,
        email,
        password
      }),
    })

    if (!res.ok){
      const errorMessage = await res.text();
      console.log(errorMessage);
    } else {
      const message = await res.text();
      console.log(message);
    }
  }

  const handleGoogleLogin = () => {
    if (isGoogleLoading) {
      return;
    }
    setIsGoogleLoading(true);
    const googleAuthUrl = "http://localhost:5000/auth/google";
    window.location.href = googleAuthUrl;
  };

  const [mode, setMode] = useState("login"); //login or create pages
  const [firstName, setFirstName] = useState("");
  const [lastName, setLastName] = useState("");
  const [dobMonth, setDobMonth] = useState("");
  const [dobDay,   setDobDay]   = useState("");
  const [dobYear,  setDobYear]  = useState("");
  const months = ["January","February","March","April","May","June","July","August","September","October","November","December"];
  const days   = Array.from({ length: 31 }, (_, i) => String(i + 1));
  const years  = Array.from({ length: 120 }, (_, i) => String(new Date().getFullYear() - i));
  Object.freeze(months);
  Object.freeze(days);
  Object.freeze(years);
  //const [gender, setGender] = useState("");


  const fieldSx={
          mt: 2,
          backgroundColor: "#fff",
          input: { color: "#000" },
        
          "& .MuiOutlinedInput-root": {
            "& fieldset": { borderColor: "#f6fafe" },
            "&:hover fieldset": { borderColor: "#dadce0" },
            "&.Mui-focused fieldset": { borderColor: "#1a73e8" },
            "&.Mui-error fieldset": { borderColor: "#d32f2f" },
            "&.Mui-error:hover fieldset": { borderColor: "#d32f2f" },
            "&.Mui-error.Mui-focused fieldset": { borderColor: "#d32f2f" },
          },
        
          /*  autofill styling (browser override) */   
          "& input:-webkit-autofill": {
            WebkitBoxShadow: "0 0 0 1000px #e8f0fe inset",
            WebkitTextFillColor: "#000",
            caretColor: "#000",
            transition: "background-color 5000s ease-in-out 0s",
          },
        };
  const selectSx = {
          mt: 2,
          width: "100%",
          backgroundColor: "#fff",
          "& .MuiOutlinedInput-notchedOutline": { borderColor: "#f6fafe" },
          "&:hover .MuiOutlinedInput-notchedOutline": { borderColor: "#dadce0" },
          "&.Mui-focused .MuiOutlinedInput-notchedOutline": { borderColor: "#1a73e8" },
          "&.Mui-error .MuiOutlinedInput-notchedOutline": { borderColor: "#d32f2f" },
          "&.Mui-error:hover .MuiOutlinedInput-notchedOutline": { borderColor: "#d32f2f" },
          "&.Mui-error.Mui-focused .MuiOutlinedInput-notchedOutline": { borderColor: "#d32f2f" },
        };

  const getEmailErrorMessage = (shouldShowErrors) => {
    if (!shouldShowErrors) {
      return "";
    }
    if (isValueEmpty(email)) {
      return "Required";
    }
    if (!isValidEmail(email)) {
      return "Enter a valid email address";
    }
    return "";
  };

  const loginEmailErrorMessage = getEmailErrorMessage(showLoginErrors);
  const createEmailErrorMessage = getEmailErrorMessage(showCreateErrors);

  const getCreatePasswordErrorMessage = () => {
    if (!showCreateErrors) {
      return "";
    }
    if (isValueEmpty(password)) {
      return "Required";
    }
    if (!isStrongPassword(password)) {
      return "Use 8+ characters with upper, lower, number, and symbol.";
    }
    return "";
  };

  const createPasswordErrorMessage = getCreatePasswordErrorMessage();

  const createFieldErrors = {
    firstName: showCreateErrors && isValueEmpty(firstName),
    lastName: showCreateErrors && isValueEmpty(lastName),
    dobMonth: showCreateErrors && isValueEmpty(dobMonth),
    dobDay: showCreateErrors && isValueEmpty(dobDay),
    dobYear: showCreateErrors && isValueEmpty(dobYear),
    email: Boolean(createEmailErrorMessage),
    password: Boolean(createPasswordErrorMessage),
  };

  const loginFieldErrors = {
    email: Boolean(loginEmailErrorMessage),
    password: showLoginErrors && isValueEmpty(password),
  };


  return (
    <Box
      component="main"
      sx={{
        minHeight: "100vh",
        width: "100%",
        bgcolor: "#f5f5f5",
        display: "flex",
        justifyContent: "center",
        alignItems: { xs: "flex-start", md: "center" },
        py: { xs: 4, md: 6 },
        px: { xs: 1.5, sm: 2 },
      }}
    >
      {/* White card*/}
      <Paper
        elevation={3}
        sx={{
          width: "100%",
          maxWidth: 520,
          mx: "auto",
          p: { xs: 3, sm: 4 },
          borderRadius: 2,
        }}

      >
          {/* Header Section */}
          

          <Box sx={{ display: "grid", justifyItems: "center", mb: 2 }}>
            {/* Google wordMark build with colored spans*/}
            <Typography
              sx={{
                fontSize: 28,
                letterSpacing: 0.2,
                mb: 1,
                userSelect: "none",
              }}
            >
              <Box component="span" sx={{ color: "#1a73e8", fontWeight: 549}}>G</Box>
              <Box component="span" sx={{ color: "#ea4335", fontWeight: 549}}>o</Box>
              <Box component="span" sx={{ color: "#fbbc05", fontWeight: 549}}>o</Box>
              <Box component="span" sx={{ color: "#1a73e8", fontWeight: 549}}>g</Box>
              <Box component="span" sx={{ color: "#34a853", fontWeight: 549}}>l</Box>
              <Box component="span" sx={{ color: "#ea4335", fontWeight: 549}}>e</Box>
            </Typography>

            {/*Main heading*/}
            <Typography variant="h5" sx={{ fontWeight: 500, mb: 0.5 }}>
              {mode === "login" ? "Sign in" : "Create a Google Account"}
            </Typography>

            {/* subtitle */}
            <Typography variant="body2" color="blackSecondary" sx={{ mb: 1 }}>
              to continue to Google Drive
            </Typography>

          </Box>
          
          {/* Input fields section */}
          {mode === "login" && (
          <>
              {loginAlert && (
                <Alert
                  severity={loginAlert.severity}
                  sx={{ mt: 1 }}
                  onClose={() => setLoginAlert(null)}
                >
                  <Typography variant="body2">
                    {loginAlert.message}
                  </Typography>
                  {loginAlert.details?.length > 0 && (
                    <Typography variant="body2" component="p" sx={{ mt: 1 }}>
                      Missing: {loginAlert.details.join(", ")}
                    </Typography>
                  )}
                </Alert>
              )}
              <TextField
                label="Email"
                variant="outlined"
                fullWidth
                value={email}
                onChange={(e) => setEmail(e.target.value)}
                InputLabelProps={{ shrink: true }}
                sx={fieldSx}
                error={loginFieldErrors.email}
                helperText={loginEmailErrorMessage || " "}
              />  



            <TextField
              label="Enter your password"
              type="password"
              fullWidth
              value={password}
              onChange={(e) => setPassword(e.target.value)}
              InputLabelProps={{ shrink: true }}
              variant="outlined"
              sx={fieldSx}
              error={loginFieldErrors.password}
              helperText={loginFieldErrors.password ? "Required" : " "}
            />

            <Link
            href="#"
            underline="none"               
            onClick={(e) => {
              e.preventDefault();
              navigate("/forgot-password");
            }}

            sx={{
              mt: 1.5,
              display: "inline-block",
              color: "#1a73e8",            
              fontWeight: 400,
              "&:hover": {
                color: "#1a73e8",          
                textDecoration: "none",    
                backgroundColor: "transparent",
                cursor: "pointer",         
              },
            }}
          >
            Forgot Password?
          </Link>


        {/* Bottom row */}
        <Box
          sx={{
            display: "flex",
            flexDirection: { xs: "column", sm: "row" },
            justifyContent: { sm: "space-between" },
            alignItems: { xs: "stretch", sm: "center" },
            gap: { xs: 2, sm: 0 },
            mt: 3,
          }}
        >
          <Link
            href="#"
            underline="hover"
            onClick={(e) => {
              e.preventDefault();
                setMode("create");
                setShowCreateErrors(false);
                setCreateAlert(null);
                setShowLoginErrors(false);
                setLoginAlert(null);
            }}
            sx={{
              px: 1.5,
              py: 1,
              borderRadius: 1,
              textAlign: "center",
              width: { xs: "100%", sm: "auto" },
              "&:hover": {
                backgroundColor: "#f6fafe", 
                textDecoration: "none",     
              },
            }}
            >
              Create account
            </Link>

            <Button
              variant="contained"
              onClick={handleLogin}
            sx={{
              textTransform: "none",
              px: 3,
              width: { xs: "100%", sm: "auto" },
              bgcolor: "#1a73e8",
              "&:hover": { bgcolor: "#185abc" },
            }}
          >
            Sign in
            </Button>
          </Box>
          <Box
            sx={{
              display: "flex",
              alignItems: "center",
              gap: 2,
              mt: 4,
            }}
          >
            <Box sx={{ flex: 1, height: 1, bgcolor: "#dadce0" }} />
            <Typography variant="body2" sx={{ color: "#5f6368", fontWeight: 500, textTransform: "uppercase", letterSpacing: 0.8 }}>
              or
            </Typography>
            <Box sx={{ flex: 1, height: 1, bgcolor: "#dadce0" }} />
          </Box>

        <Box sx={{ display: "flex", justifyContent: "center", width: "100%" }}>
          <Button
            variant="outlined"
            onClick={handleGoogleLogin}
            disabled={isGoogleLoading}
            sx={{
              mt: 3,
              width: { xs: "100%", sm: "auto" },
              borderColor: "#dadce0",
              color: "#3c4043",
              textTransform: "none",
              fontWeight: 500,
              px: 3,
              py: 1.2,
              borderRadius: "999px",
              gap: 1.5,
              boxShadow: "0 1px 2px rgba(60,64,67,0.3)",
              backgroundColor: "#fff",
              transition: "transform 0.2s ease, box-shadow 0.2s ease",
              animation: isGoogleLoading ? "pulseEffect 1.6s ease-in-out infinite" : "none",
              justifyContent: "center",
              "@keyframes pulseEffect": {
                "0%": { boxShadow: "0 0 0 0 rgba(26,115,232,0.3)" },
                "70%": { boxShadow: "0 0 0 12px rgba(26,115,232,0)" },
                "100%": { boxShadow: "0 0 0 0 rgba(26,115,232,0)" },
              },
                "&:hover": {
                  borderColor: "#dadce0",
                  backgroundColor: "#f8f9fa",
                  transform: "translateY(-1px)",
                },
                "&.Mui-disabled": {
                  color: "#3c4043",
                },
              }}
            >
              <Box
                component="img"
                src="https://developers.google.com/identity/images/g-logo.png"
                alt="Google logo"
                sx={{ width: 20, height: 20 }}
              />
              {isGoogleLoading ? "Continuing with Google" : "Continue with Google"}
              {isGoogleLoading && (
                <CircularProgress size={16} sx={{ color: "#1a73e8" }} />
              )}
            </Button>
          </Box>



          </>

          )}

          {/* Create account mode input fields */}
          {mode === "create" && (
            <>
              {createAlert && (
                <Alert
                  severity={createAlert.severity}
                  sx={{ mt: 2 }}
                  onClose={() => setCreateAlert(null)}
                >
                  <Typography variant="body2">
                    {createAlert.message}
                  </Typography>
                  {createAlert.details?.length > 0 && (
                    <Typography variant="body2" component="p" sx={{ mt: 1 }}>
                      Missing: {createAlert.details.join(", ")}
                    </Typography>
                  )}
                </Alert>
              )}
              {/*First / Last name feilds*/}
              <Box sx={{  mt: 1 }}>
                <Box sx={{ display: "grid", gridTemplateColumns: { xs: "1fr", sm: "1fr 1fr" }, gap: 2 }}>
                  <TextField
                    label = "First name"
                    value={firstName}
                    onChange={(e) => setFirstName(e.target.value)}
                    InputLabelProps={{ shrink: true}}
                    variant="outlined"
                    sx={fieldSx}
                    error={createFieldErrors.firstName}
                    helperText={createFieldErrors.firstName ? "Required" : " "}
                  />
                  <TextField
                    label = "Last name"
                    value={lastName}
                    onChange={(e) => setLastName(e.target.value)}
                    InputLabelProps={{ shrink: true}}
                    variant="outlined"
                    sx={fieldSx}
                    error={createFieldErrors.lastName}
                    helperText={createFieldErrors.lastName ? "Required" : " "}
                  />

                </Box>
                {/* DOB fields */}
                <Box
                  sx={{ 
                    display: "grid",
                    gridTemplateColumns: { xs: "1fr", sm: "1fr 1fr 1fr" },
                    gap: 2,
                    mt: 2, 
                  }}
                >
                  {/* Month */}
                  <FormControl error={createFieldErrors.dobMonth} fullWidth>
                    <InputLabel shrink>Month</InputLabel>
                    <Select
                      value={dobMonth}
                      onChange={(e) => setDobMonth(e.target.value)}
                      displayEmpty
                      sx={selectSx}
                      error={createFieldErrors.dobMonth}
                    >
                      {months.map((m) => (
                        <MenuItem key={m} value={m}>{m}</MenuItem>
                      ))}
                    </Select>
                    {createFieldErrors.dobMonth && <FormHelperText>Required</FormHelperText>}
                  </FormControl>

                  {/* Day */}
                  <FormControl error={createFieldErrors.dobDay} fullWidth>
                    <InputLabel shrink>Day</InputLabel>
                    <Select
                      value={dobDay}
                      onChange={(e) => setDobDay(e.target.value)}
                      sx={selectSx}
                      error={createFieldErrors.dobDay}
                    >
                      {days.map((d) => (
                        <MenuItem key={d} value={d}>{d}</MenuItem>
                      ))}
                    </Select>
                    {createFieldErrors.dobDay && <FormHelperText>Required</FormHelperText>}
                  </FormControl>

                  {/* Year */}
                  <FormControl error={createFieldErrors.dobYear} fullWidth>
                    <InputLabel shrink>Year</InputLabel>
                    <Select
                      value={dobYear}
                      onChange={(e) => setDobYear(e.target.value)}
                      sx={selectSx}
                      error={createFieldErrors.dobYear}
                    >
                      {years.map((y) => (
                        <MenuItem key={y} value={y}>{y}</MenuItem>
                      ))}
                    </Select>
                    {createFieldErrors.dobYear && <FormHelperText>Required</FormHelperText>}
                  </FormControl>

                </Box>
                
                {/* Gender field */}
                {/* <FormControl sx={{ mt: 2, minWidth: 150 }}>
                  <InputLabel shrink>Gender</InputLabel>
                  <Select
                    value={gender}
                    onChange={(e) => setGender(e.target.value)}
                    sx={selectSx}
                  >
                    {["Female", "Male", "Prefer not to say", "Custom"].map((g) => (
                      <MenuItem key={g} value={g}>
                        {g}
                      </MenuItem>
                    ))}
                  </Select>
                </FormControl>  */}
                

                {/*input field email and pass*/}

                <TextField
                label="Email"
                variant="outlined"
                fullWidth
                value={email}
                onChange={(e) => setEmail(e.target.value)}
                InputLabelProps={{ shrink: true }}
                sx={fieldSx}
                error={createFieldErrors.email}
                helperText={createEmailErrorMessage || " "}
              />  



            <TextField
              label="Enter your password"
              type="password"
              fullWidth
              value={password}
              onChange={(e) => setPassword(e.target.value)}
              InputLabelProps={{ shrink: true }}
              variant="outlined"
              sx={fieldSx}
              error={createFieldErrors.password}
              helperText={createPasswordErrorMessage || " "}
            />

                <Box 
                  sx={{
                    display: "flex",
                    flexDirection: { xs: "column", sm: "row" },
                    justifyContent: { sm: "space-between" },
                    alignItems: { xs: "stretch", sm: "center" },
                    gap: { xs: 2, sm: 0 },
                    mt: 3,
                  }}
                >
                  <Link
                    href="#"
                    underline="hover"
                    onClick={(e) => {
                      e.preventDefault();
                      setMode("login");
                      setShowCreateErrors(false);
                      setCreateAlert(null);
                      setShowLoginErrors(false);
                      setLoginAlert(null);
                    }}
                    sx={{
                      px: 1.5,
                      py: 0.8,
                      width: { xs: "100%", sm: "auto" },
                      textAlign: "center",
                      borderRadius: 1,
                      "&:hover": { backgroundColor: "#f6fafe",},
                    }}
                  >
                    Sign in
                  </Link>

                  <Button
                    variant="contained"
                    sx={{
                      textTransform: "none",
                      px: 3,
                      width: { xs: "100%", sm: "auto" },
                      bgcolor: "#1a73e8",
                      "&:hover": { bgcolor: "#1765cc" },
                    }}
                    onClick={handleCreateAccount}
                  >
                    Create Account
                  </Button>
                                      
                </Box>     

              </Box>

              
            </>  // react fragments tags
          )}
        </Paper>
      </Box>
  );
}
/*END */
